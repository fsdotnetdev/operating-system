# Chapter 01 : Hardware and Software Overview

## Topic
* OS Architecture
* CPU
* CPU Instruction Process
* Instruction Format
* Example Program Execute
* Register
* I/O Controller
* I/O Controller Status


## OS Architecture
> ```
>
>                   CPU                                                             Main Memory
>   +---------------------------------+                                 +---------------------------------+
>   |                                 |                                 |                 .               |
>   |   +--------+      +---------+   |                                 |                 .               |
>   |   |   PC   |      |   MAR   |   |                                 |                 .               |
>   |   +--------+      +---------+   |                                 |---------------------------------|
>   |                                 |                                 |           Instruction           |
>   |   +--------+      +---------+   |                                 |---------------------------------|
>   |   |   IR   |      |   MBR   |   |                                 |           Instruction           |
>   |   +--------+      +---------+   |            System Bus           |---------------------------------|
>   |                                 |-----------------+---------------|           Instruction           |
>   |   +-----------+   +---------+   |                 |               |---------------------------------|
>   |   |           |   | I/O  AR |   |                 |               |                 .               |
>   |   | Execution |   +---------+   |                 |               |                 .               |
>   |   |           |                 |                 |               |                 .               |
>   |   |    Unit   |   +---------+   |                 |               |---------------------------------|
>   |   |           |   | I/O  BR |   |                 |               |               Data              |
>   |   +-----------+   +---------+   |                 |               |---------------------------------|
>   |                                 |                 |               |               Data              |
>   +---------------------------------+                 |               |---------------------------------|
>                                                       |               |               Data              |
>                 I/O Module                            |               |---------------------------------|
>   +---------------------------------+                 |               |                 .               |
>   |                                 |                 |               |                 .               |
>   |               +-----------+     |                 |               |                 .               |
>   |               |-----------|     |                 |               +---------------------------------+
>   |               |-----------|     |                 |
>   |               |-----------|     |                 |
>   |               |     .     |     |-----------------+
>   |               |     .     |     |
>   |               |     .     |     |
>   |               +-----------+     |
>   |                   Buffer        |
>   |                                 |
>   +---------------------------------+
>   
> ```

## CPU (Central Processing Unit)
ทำหน้าที่ควบคุมการทำงานของคอมพิวเตอร์ และทำหน้าที่ประมวลผลข้อมูล Data Processing ภายใน CPU หลัก ๆ จะประกอบไปด้วย
* PC  = Program Counter

* IR  = Instruction Register

* MAR = Memory Address Register
เป็น Register ที่ทำหน้าที่ในการเก็บ Address ของ Data ที่ถูก Fetch จาก Memory มาทำงานที่ CPU เพื่อเวลาที่ทำงานเสร็จจะเก็บค่าลงบน Memory ได้ถูก

* MBR = Memory Buffer Register

* I/O AR = Input/Output Address Register

* I/O BR = Input/Output Buffer Register

## 32-bit vs 64-bit
ในปัจจุบันคอมพิวเตอร์จะมีสถาปัตยกรรมสองแบบ คือ 32 บิต หรือ 64 บิต ซึ่งไว้เก็บ Address
#### อธิบายง่าย ๆ
* MAR 1 บิต เก็บได้แค่ 0 และ 1 บนเลขฐานสอง
* ถ้า MAR 8 บิต จะเก็บ Address ได้ 2^n 
* Memory จะเก็บเป็น byte จะได้ 2^8 = 256 byte
> ```
> 
>                      MAR
>     0    1    2    3    4    5    6    7                                       Memory
>   +---------------------------------------+                  +---------------------------------------+       
>   |    |    |    |    |    |    |    |    |               0  |    |    |    |    |    |    |    |    |
>   +---------------------------------------+                  +---------------------------------------+
>      |                                                    1  |    |    |    |    |    |    |    |    |
>      |                                                       +---------------------------------------+
>      V                                                    2  |    |    |    |    |    |    |    |    |
>    1 bit                                                     +---------------------------------------+
>
>                                                              |---------------  1 byte  --------------|
>
> ```

กลับมาที่ 32-bit และ 64-bit บน Memory ก็จะเก็บได้ 2^32 byte และ 2^64 byte หากแปลงจะต้องใช้หน่วย SI ในการแปลง โดนเทียบระหว่างเลขฐาน 10 และเลขฐานสอง
เช่น 1 Kilo = 1000 หากเป็นเลขฐานสองจะได้ 2^10 = 1024 ดังนั้น
* 32-bit = 30 + 2 => 2^30 * 2^2 => 4GB
* 64-bit = 60 + 4 => 2^60 * 2^4 => 16EB

#### คำอุปสรรคเอสไอ (SI Unit)
> ```
>
> +----------+---------+-------------+---------------+
> |   Name   |   Sym.  |    Quant.   |   2 Deciaml   |
> +----------+---------+-------------+---------------+
> |   Exa    |    E    |   10 ^ 18   |     2 ^ 60    |
> |   Peta   |    P    |   10 ^ 15   |     2 ^ 50    |
> |   Tera   |    T    |   10 ^ 12   |     2 ^ 40    |
> |   Giga   |    G    |   10 ^ 09   |     2 ^ 30    |
> |   Mega   |    M    |   10 ^ 06   |     2 ^ 20    |
> |   Kilo   |    K    |   10 ^ 03   |     2 ^ 10    |
> +----------+---------+-------------+---------------+
>
> ```

## CPU Instruction Process
การทำงานของ CPU จะเริ่มจากการ Fetch Instruction ซึ่งจะถูกเก็บอยู่บน Memory ขึ้นมา แล้วทำการ Decode เพื่อแปลงเป็นภาษา Assembly จากนั้นจึงทำการ Execute ตัวโปรแกรม
> ```
>
>   +-----------+         +-----------+         +-----------+         +-----------+
>   |   Start   |-------->|   Fetch   |-------->|    Exec   |-------->|    Halt   |
>   +-----------+         +-----------+         +-----------+         +-----------+
>
> ```

## Instruction Format
> ```
>
>   0              3 4                                       15
>   +---------------+-----------------------------------------+
>   |     Opcode    |                 Address                 |
>   +---------------+-----------------------------------------+
>
> ```
- 0001 = Load AC จาก Memory
- 0010 = Store AC ไปเก็บใน Memory
- 0101 = Add AC จาก Memory

## Example Program Execute
> ```
>
>                        Fetch Stage                                       Execute Stage
>   +--------------------------------------------------+--------------------------------------------------+
>   |                                                  |                                                  |
>   |        Memory                  CPU Register      |        Memory                  CPU Register      |
>   |        +---------+             +---------+       |        +---------+             +---------+       |
>   |    300 | 1 9 4 0 |------+      |   3 0 0 | PC    |    300 | 1 9 4 0 |             |   3 0 1 | PC    |
>   |        |---------|      |      |---------|       |        |---------|             |---------|       |
>   |    301 | 5 9 4 1 |      |      |         | AC    |    301 | 5 9 4 1 |      +------| 0 0 0 3 | AC    |
>   |        |---------|      |      |---------|       |        |---------|      |      |---------|       |
>   |    302 | 2 9 4 1 |      +------| 1 9 4 0 | IR    |    302 | 2 9 4 1 |      |      | 1 9 4 0 | IR    |
>   |        +---------+             +---------+       |        +---------+      |      +---------+       |
>   |             .                                    |             .           |                        |
>   |             .                                    |             .           |                        |
>   |        +---------+                               |        +---------+      |                        |
>   |    940 | 0 0 0 3 |                               |    940 | 0 0 0 3 |------+                        |
>   |        |---------|                               |        |---------|                               |
>   |    941 | 0 0 0 2 |                               |    941 | 0 0 0 2 |                               |
>   |        +---------+                 Stage 1       |        +---------+                 Stage 2       |
>   |                                                  |                                                  |
>   +--------------------------------------------------+--------------------------------------------------+
>   |                                                  |                                                  |
>   |        Memory                  CPU Register      |        Memory                  CPU Register      |
>   |        +---------+             +---------+       |        +---------+             +---------+       |
>   |    300 | 1 9 4 0 |             |   3 0 1 | PC    |    300 | 1 9 4 0 |             |   3 0 2 | PC    |
>   |        |---------|             |---------|       |        |---------|             |---------|       |
>   |    301 | 5 9 4 1 |------+      | 0 0 0 3 | AC    |    301 | 5 9 4 1 |      +------| 0 0 0 5 | AC    |
>   |        |---------|      |      |---------|       |        |---------|      |      |---------|       |
>   |    302 | 2 9 4 1 |      +------| 5 9 4 1 | IR    |    302 | 2 9 4 1 |      |      | 5 9 4 1 | IR    |
>   |        +---------+             +---------+       |        +---------+      |      +---------+       |
>   |             .                                    |             .           |                        |
>   |             .                                    |             .           +------  3 + 2 = 5       |
>   |        +---------+                               |        +---------+                   |           |
>   |    940 | 0 0 0 3 |                               |    940 | 0 0 0 3 |                   |           |
>   |        |---------|                               |        |---------|                   |           |
>   |    941 | 0 0 0 2 |                               |    941 | 0 0 0 2 |-------------------+           |
>   |        +---------+                 Stage 3       |        +---------+                 Stage 4       |
>   |                                                  |                                                  |
>   +--------------------------------------------------+--------------------------------------------------+
>   |                                                  |                                                  |
>   |        Memory                  CPU Register      |        Memory                  CPU Register      |
>   |        +---------+             +---------+       |        +---------+             +---------+       |
>   |    300 | 1 9 4 0 |             |   3 0 2 | PC    |    300 | 1 9 4 0 |             |   3 0 3 | PC    |
>   |        |---------|             |---------|       |        |---------|             |---------|       |
>   |    301 | 5 9 4 1 |             | 0 0 0 5 | AC    |    301 | 5 9 4 1 |      +------| 0 0 0 5 | AC    |
>   |        |---------|             |---------|       |        |---------|      |      |---------|       |
>   |    302 | 2 9 4 1 |------+------| 2 9 4 1 | IR    |    302 | 2 9 4 1 |      |      | 2 9 4 1 | IR    |
>   |        +---------+             +---------+       |        +---------+      |      +---------+       |
>   |             .                                    |             .           |                        |
>   |             .                                    |             .           |                        |
>   |        +---------+                               |        +---------+      |                        |
>   |    940 | 0 0 0 3 |                               |    940 | 0 0 0 3 |      |                        |
>   |        |---------|                               |        |---------|      |                        |
>   |    941 | 0 0 0 2 |                               |    941 | 0 0 0 5 |------+                        |
>   |        +---------+                 Stage 5       |        +---------+                 Stage 6       |
>   |                                                  |                                                  |
>   +--------------------------------------------------+--------------------------------------------------+
>             
> ```
1. ภายใน CPU Register จะมีค่า PC เท่ากับ 300 ซึ่งระบุ Address ที่อยู่บน Memory มันจะไปดึงค่าที่ตรงกับ Address นั้นขึ้นมาไว้ใน IR พร้อมทั้งเพิ่มค่า PC ไปยัง Addres ถัดไป ( Address อาจจะไม่ได้อยู่ติดกัน ) จะมีการใช้ MAR และ MBR
2. เราจะได้ค่ามาอยู่ใน IR ในรูปของ Hexadecimal Digit เลขฐาน 16 ตาม Instruction Format โดยมี 4 bit แรกระบุ Opcode และ 12 bit หลังระบุ Address หมายความว่าในรูป เราจะได้ Address ที่ 940 จากนั้นเราก็ไปนำค่าที่ตรงกับ Address มาเก็บไว้ใน AC
3. หลังจากเพิ่มค่า PC เท่ากับ 301 มันจะไปดึงค่าถัดไปมาเก็บไว้ใน IR แทนที่ค่าเดิม พร้อมทั้งเพิ่มค่า PC
4. จากนั้นก็จะไปดึงค่าที่ตรงกับ Address มาเก็บไว้ใน AC แต่ภายใน AC มีค่าอยู่ มันก็จะนำค่าเดิมกับค่าใหม่มาคำนวณแล้วเก็บลงใน AC เหมือนเดิม
5. หลังจากเพิ่มค่า PC เท่ากับ 302 มันจะไปดึงค่าถัดไปมาเก็บไว้ใน IR แทนที่ค่าเดิม พร้อมทั้งเพิ่มค่า PC
6. เป็นการบอกให้นำค่าใน AC เก็บลงไปใน Address ตามค่าใน IR

## Register
* PC (Program Counter)
ทำหน้าที่ในการระบุ Address ของ Instruction ถัดไป ที่อยู่บน Memory

* IR (Instruction Register)
ทำหน้าที่ในการเก็บ Instruction ปัจจุบันที่กำลังถูก Executed หรือ Decode อยู่

* SP (Stack Pointer)
ทำหน้าที่ในการ Pointer การทำงานที่ทำอยู่ใน User Stack

* PSW (Program Status Word)
ทำหน้าที่ใช้ในการระบุโหมเพื่อเข้าถึง Instruction ตาม Pritority ของ CPU แบ่งเป็น User Mode, Kernel Mode

* AC (Acuumulator Storage)
ทำหน้าที่ในการเก็บค่าไว้ชั่วคราว

## I/O Controller
ในบางตำราจะเรียก I/O Module เป็นตัวควบคุมอุปกรณ์ I/O Device แทนที่จะให้ CPU ควบคุมโดยตรง ทำหน้าที่ในการ Transfer Data ระหว่าง External Data กับ CPU ใน I/O Controller ประกอบไปด้วย Register
* Controller Register
ทำหน้าที่ Communication กับ CPU โดย CPU จะสั่ง Controller ให้ทำงานได้ต้องเขียนคำสั่งลงใน Controller Register

* Status Register
CPU สามารถตรวจสอบสถานะการทำงานของ I/O Controller ได้จาก Status Register

* Data Register
ทำหน้าที่ในการเก็บข้อมูลจาก System Bus ไว้ใน Buffer

## I/O Controller Status
> ```
>
> +---------+---------+--------------+
> |   Busy  |   Done  |  Error Code  |
> +---------+---------+--------------+
> |    0    |    0    |   idle       |
> |    0    |    1    |   finish     |
> |    1    |    0    |   working    |
> |    1    |    1    |   undefined  |
> +---------+---------+--------------+
>
> ```

## CPU Communication with Register
* I/O Port
แต่ละ Control Register จะถูก Assign ด้วย I/O Port Number 8/16 bit

* Memory-mapped I/O

* Hybrid

## I/O Communication
* Program I/O
จะมี Driver คอยบอก Controller
CPU จะต้องคอยให้ I/O ทำเสร็จก่อน I/O ตัวถัดไปถึงจะได้ใช้ 
Data Transfer จะรับส่งด้วย CPU ทั้งหมด

* Interrupt-driven I/O
จะมี Interrupt Controller เพิ่มเข้ามา

Interrupt Handler

Interrupt Vector

* Derect Memory Access (DMA)


## Address Translation

## MMU (Memory Management Unit)
เป็นอุปกรณ์ Hardware ที่ทำหน้าที่ในการ Map ระหว่าง Logical Address (CPU) และ Physical Address (Memory) ในตัว MMU จะมีการ Protect เพื่อไม่ให้สามารถอ้างถิง Memory ในตำแหน่งอื่น โดยไม่ได้รับอนุญาต
> ```
>
>                  CPU Package                                                      Main Memory
>     +-----------------------------------+                             +---------------------------------+
>   --|                                   |--                           |                                 |
>     |     call 0600                     |                             |                                 |
>   --|                                   |--                           |                                 |
>     |     +-------+       +-------+     |                             |                                 |
>   --|     |       |  600  |       |     |--                           |                                 |
>     |     |  CPU  |------>|  MMU  |     |                             |                                 |
>   --|     |       |       |       |     |--                           |                                 |
>     |     +-------+       +-------+     |                             |                                 |
>   --|                          |        |--                           |                                 |
>     +-----------------------------------+                             |                                 |
>                                |                                      |                                 |
>                                |                                      |                                 |
>                                V                                      |                                 |
>                          +-----+-----+                                |                                 |
>                          |     |     |                                |                                 |
>                          +-----+-----+                                |                                 |
>                          |     |     |             4600               |                                 |
>                          +-----+-----+ ------------------------------>|                                 |
>                          |     |     |                                |                                 |
>                          +-----+-----+                                |                                 |
>                          |     |     |                                |                                 |
>                          +-----+-----+                                +---------------------------------+
>                          Mapping Table
>
> ```


> ```
>    
>     +---------------+
>   --|               |--
>     |               |
>   --|      CPU      |--
>     |               |
>   --|               |--
>     +---------------+
>
> ```

## System Bus
เป็นช่องทางการสื่อสาร

## Credit
Operatin System (6th Edition)
